# SystemOSIOTéƒ¨ç½²è¿ç»´æŒ‡å— / Deployment and Operations Guide

```text
title: éƒ¨ç½²è¿ç»´æŒ‡å—
description: SystemOSIOTé¡¹ç›®éƒ¨ç½²å’Œè¿ç»´æŒ‡å—ï¼Œå»ºç«‹å®Œæ•´çš„éƒ¨ç½²è¿ç»´ä½“ç³»
author: SystemOSIOT Team
created: 2024-01-15
updated: 2024-01-15
version: 1.0.0
tags: [éƒ¨ç½²æŒ‡å—, è¿ç»´æ‰‹å†Œ, è¿ç»´ä½“ç³»]
```

## ðŸ“‘ ç›®å½• / Table of Contents

- [SystemOSIOTéƒ¨ç½²è¿ç»´æŒ‡å— / Deployment and Operations Guide](#systemosiotéƒ¨ç½²è¿ç»´æŒ‡å—--deployment-and-operations-guide)
  - [ðŸ“‘ ç›®å½• / Table of Contents](#-ç›®å½•--table-of-contents)
  - [ðŸ—ï¸ éƒ¨ç½²æž¶æž„æ¦‚è¿° / Deployment Architecture Overview](#ï¸-éƒ¨ç½²æž¶æž„æ¦‚è¿°--deployment-architecture-overview)
    - [æ•´ä½“æž¶æž„å›¾ / Overall Architecture](#æ•´ä½“æž¶æž„å›¾--overall-architecture)
    - [éƒ¨ç½²æ‹“æ‰‘ / Deployment Topology](#éƒ¨ç½²æ‹“æ‰‘--deployment-topology)
      - [ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²](#ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²)
  - [âš™ï¸ çŽ¯å¢ƒé…ç½®ç®¡ç† / Environment Configuration Management](#ï¸-çŽ¯å¢ƒé…ç½®ç®¡ç†--environment-configuration-management)
    - [é…ç½®æ–‡ä»¶ç»“æž„ / Configuration File Structure](#é…ç½®æ–‡ä»¶ç»“æž„--configuration-file-structure)
      - [åº”ç”¨é…ç½®æ–‡ä»¶](#åº”ç”¨é…ç½®æ–‡ä»¶)
      - [çŽ¯å¢ƒå˜é‡é…ç½®](#çŽ¯å¢ƒå˜é‡é…ç½®)
    - [é…ç½®ç®¡ç†å·¥å…· / Configuration Management Tools](#é…ç½®ç®¡ç†å·¥å…·--configuration-management-tools)
      - [Spring Cloud Configé…ç½®](#spring-cloud-configé…ç½®)
  - [ðŸ³ å®¹å™¨åŒ–éƒ¨ç½² / Containerized Deployment](#-å®¹å™¨åŒ–éƒ¨ç½²--containerized-deployment)
    - [Dockeré…ç½® / Docker Configuration](#dockeré…ç½®--docker-configuration)
      - [åº”ç”¨Dockerfile](#åº”ç”¨dockerfile)
      - [å¯åŠ¨è„šæœ¬](#å¯åŠ¨è„šæœ¬)
      - [Docker Composeé…ç½®](#docker-composeé…ç½®)
    - [Kuberneteséƒ¨ç½² / Kubernetes Deployment](#kuberneteséƒ¨ç½²--kubernetes-deployment)
      - [åº”ç”¨éƒ¨ç½²é…ç½®](#åº”ç”¨éƒ¨ç½²é…ç½®)
      - [æœåŠ¡é…ç½®](#æœåŠ¡é…ç½®)
      - [Ingressé…ç½®](#ingressé…ç½®)
  - [ðŸ¤– è‡ªåŠ¨åŒ–éƒ¨ç½² / Automated Deployment](#-è‡ªåŠ¨åŒ–éƒ¨ç½²--automated-deployment)
    - [CI/CDæµæ°´çº¿ / CI/CD Pipeline](#cicdæµæ°´çº¿--cicd-pipeline)
      - [GitHub Actionsé…ç½®](#github-actionsé…ç½®)
      - [Jenkins Pipelineé…ç½®](#jenkins-pipelineé…ç½®)
  - [ðŸ“Š ç›‘æŽ§å’Œå‘Šè­¦ / Monitoring and Alerting](#-ç›‘æŽ§å’Œå‘Šè­¦--monitoring-and-alerting)
    - [ç›‘æŽ§ä½“ç³» / Monitoring System](#ç›‘æŽ§ä½“ç³»--monitoring-system)
      - [Prometheusé…ç½®](#prometheusé…ç½®)
      - [å‘Šè­¦è§„åˆ™](#å‘Šè­¦è§„åˆ™)
    - [æ—¥å¿—ç®¡ç† / Log Management](#æ—¥å¿—ç®¡ç†--log-management)
      - [ELK Stacké…ç½®](#elk-stacké…ç½®)
  - [ðŸ› ï¸ è¿ç»´æ“ä½œæŒ‡å— / Operations Guide](#ï¸-è¿ç»´æ“ä½œæŒ‡å—--operations-guide)
    - [æ—¥å¸¸è¿ç»´æ“ä½œ / Daily Operations](#æ—¥å¸¸è¿ç»´æ“ä½œ--daily-operations)
      - [åº”ç”¨é‡å¯è„šæœ¬](#åº”ç”¨é‡å¯è„šæœ¬)
      - [æ•°æ®åº“å¤‡ä»½è„šæœ¬](#æ•°æ®åº“å¤‡ä»½è„šæœ¬)
    - [æ•…éšœå¤„ç†æµç¨‹ / Troubleshooting Process](#æ•…éšœå¤„ç†æµç¨‹--troubleshooting-process)
      - [æ•…éšœå“åº”æµç¨‹](#æ•…éšœå“åº”æµç¨‹)
      - [å¸¸è§æ•…éšœå¤„ç† / Common Incident Handling](#å¸¸è§æ•…éšœå¤„ç†--common-incident-handling)

## ðŸ—ï¸ éƒ¨ç½²æž¶æž„æ¦‚è¿° / Deployment Architecture Overview

### æ•´ä½“æž¶æž„å›¾ / Overall Architecture

```mermaid
graph TB
    subgraph "ç”¨æˆ·å±‚ / User Layer"
        A[Webå‰ç«¯] --> B[ç§»åŠ¨åº”ç”¨]
        A --> C[APIå®¢æˆ·ç«¯]
    end
    
    subgraph "è´Ÿè½½å‡è¡¡å±‚ / Load Balancer Layer"
        D[Nginx] --> E[HAProxy]
    end
    
    subgraph "åº”ç”¨æœåŠ¡å±‚ / Application Service Layer"
        F[ç”¨æˆ·æœåŠ¡] --> G[è®¢å•æœåŠ¡]
        F --> H[å•†å“æœåŠ¡]
        F --> I[æ”¯ä»˜æœåŠ¡]
    end
    
    subgraph "æ•°æ®å­˜å‚¨å±‚ / Data Storage Layer"
        J[MySQLä¸»ä»Ž] --> K[Redisé›†ç¾¤]
        L[MongoDB] --> M[Elasticsearch]
    end
    
    subgraph "æ¶ˆæ¯é˜Ÿåˆ—å±‚ / Message Queue Layer"
        N[RabbitMQ] --> O[Kafka]
    end
    
    subgraph "ç›‘æŽ§è¿ç»´å±‚ / Monitoring Layer"
        P[Prometheus] --> Q[Grafana]
        R[Jaeger] --> S[ELK Stack]
    end
    
    B --> D
    C --> D
    E --> F
    E --> G
    E --> H
    E --> I
    F --> J
    F --> K
    G --> J
    G --> N
    H --> L
    H --> M
    I --> J
    I --> N
    P --> F
    P --> G
    P --> H
    P --> I
```

### éƒ¨ç½²æ‹“æ‰‘ / Deployment Topology

#### ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²

```yaml
# ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²é…ç½®
production:
  regions:
    - name: "åŽåŒ—åœ°åŒº"
      availability_zones:
        - name: "az-1"
          servers:
            - role: "web"
              count: 3
              instance_type: "ecs.g7.2xlarge"
            - role: "app"
              count: 6
              instance_type: "ecs.g7.4xlarge"
            - role: "db"
              count: 2
              instance_type: "rds.mysql.x8.2xlarge"
    
    - name: "åŽä¸œåœ°åŒº"
      availability_zones:
        - name: "az-1"
          servers:
            - role: "web"
              count: 2
              instance_type: "ecs.g7.2xlarge"
            - role: "app"
              count: 4
              instance_type: "ecs.g7.4xlarge"
            - role: "db"
              count: 1
              instance_type: "rds.mysql.x8.2xlarge"
```

## âš™ï¸ çŽ¯å¢ƒé…ç½®ç®¡ç† / Environment Configuration Management

### é…ç½®æ–‡ä»¶ç»“æž„ / Configuration File Structure

#### åº”ç”¨é…ç½®æ–‡ä»¶

```yaml
# application.yml
spring:
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  
  datasource:
    url: ${DB_URL:jdbc:mysql://localhost:3306/systemosiot}
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:password}
    hikari:
      maximum-pool-size: ${DB_MAX_POOL_SIZE:20}
      minimum-idle: ${DB_MIN_IDLE:5}
      connection-timeout: ${DB_CONNECTION_TIMEOUT:30000}
  
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: ${REDIS_DATABASE:0}
    timeout: ${REDIS_TIMEOUT:5000}
    lettuce:
      pool:
        max-active: ${REDIS_MAX_ACTIVE:20}
        max-idle: ${REDIS_MAX_IDLE:10}
        min-idle: ${REDIS_MIN_IDLE:5}
  
  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}
    port: ${RABBITMQ_PORT:5672}
    username: ${RABBITMQ_USERNAME:guest}
    password: ${RABBITMQ_PASSWORD:guest}
    virtual-host: ${RABBITMQ_VHOST:/}

# åº”ç”¨é…ç½®
app:
  name: ${APP_NAME:systemosiot}
  version: ${APP_VERSION:1.0.0}
  port: ${APP_PORT:8080}
  
  security:
    jwt:
      secret: ${JWT_SECRET:your-secret-key}
      expiration: ${JWT_EXPIRATION:86400000}
  
  logging:
    level: ${LOG_LEVEL:INFO}
    file: ${LOG_FILE:/var/log/systemosiot/app.log}
  
  cache:
    ttl: ${CACHE_TTL:3600}
    max-size: ${CACHE_MAX_SIZE:10000}
```

#### çŽ¯å¢ƒå˜é‡é…ç½®

```bash
# .env.production
# æ•°æ®åº“é…ç½®
DB_URL=jdbc:mysql://prod-db-cluster:3306/systemosiot
DB_USERNAME=systemosiot_user
DB_PASSWORD=secure_password_123
DB_MAX_POOL_SIZE=50
DB_MIN_IDLE=10
DB_CONNECTION_TIMEOUT=60000

# Redisé…ç½®
REDIS_HOST=prod-redis-cluster
REDIS_PORT=6379
REDIS_PASSWORD=redis_password_123
REDIS_DATABASE=0
REDIS_MAX_ACTIVE=50
REDIS_MAX_IDLE=20
REDIS_MIN_IDLE=10

# RabbitMQé…ç½®
RABBITMQ_HOST=prod-rabbitmq-cluster
RABBITMQ_PORT=5672
RABBITMQ_USERNAME=systemosiot_user
RABBITMQ_PASSWORD=mq_password_123
RABBITMQ_VHOST=/systemosiot

# åº”ç”¨é…ç½®
APP_NAME=systemosiot
APP_VERSION=1.0.0
APP_PORT=8080
SPRING_PROFILES_ACTIVE=production

# å®‰å…¨é…ç½®
JWT_SECRET=your-super-secure-jwt-secret-key-2024
JWT_EXPIRATION=86400000

# æ—¥å¿—é…ç½®
LOG_LEVEL=WARN
LOG_FILE=/var/log/systemosiot/app.log

# ç¼“å­˜é…ç½®
CACHE_TTL=3600
CACHE_MAX_SIZE=50000
```

### é…ç½®ç®¡ç†å·¥å…· / Configuration Management Tools

#### Spring Cloud Configé…ç½®

```yaml
# bootstrap.yml
spring:
  cloud:
    config:
      uri: ${CONFIG_SERVER_URI:http://localhost:8888}
      name: ${CONFIG_NAME:systemosiot}
      profile: ${CONFIG_PROFILE:${SPRING_PROFILES_ACTIVE:dev}}
      label: ${CONFIG_LABEL:main}
      fail-fast: true
      retry:
        initial-interval: 1000
        max-interval: 2000
        max-attempts: 6
        multiplier: 1.1
```

## ðŸ³ å®¹å™¨åŒ–éƒ¨ç½² / Containerized Deployment

### Dockeré…ç½® / Docker Configuration

#### åº”ç”¨Dockerfile

```dockerfile
# Dockerfile
FROM openjdk:11-jre-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…å¿…è¦çš„å·¥å…·
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# å¤åˆ¶åº”ç”¨JARæ–‡ä»¶
COPY target/systemosiot-*.jar app.jar

# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY scripts/startup.sh startup.sh
RUN chmod +x startup.sh

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /var/log/systemosiot && \
    chown -R appuser:appuser /var/log/systemosiot

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health || exit 1

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["./startup.sh"]
```

#### å¯åŠ¨è„šæœ¬

```bash
#!/bin/bash
# startup.sh

# è®¾ç½®JVMå‚æ•°
JVM_OPTS="-Xms${JVM_XMS:-1g} -Xmx${JVM_XMX:-2g} \
    -XX:+UseG1GC \
    -XX:MaxGCPauseMillis=200 \
    -XX:+UnlockExperimentalVMOptions \
    -XX:+UseCGroupMemoryLimitForHeap \
    -XX:MaxRAMFraction=2 \
    -Djava.security.egd=file:/dev/./urandom \
    -Dspring.profiles.active=${SPRING_PROFILES_ACTIVE:-default}"

# å¯åŠ¨åº”ç”¨
exec java $JVM_OPTS -jar app.jar
```

#### Docker Composeé…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    container_name: systemosiot-app
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - DB_URL=jdbc:mysql://db:3306/systemosiot
      - REDIS_HOST=redis
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - db
      - redis
      - rabbitmq
    volumes:
      - app-logs:/var/log/systemosiot
    restart: unless-stopped
    networks:
      - app-network

  db:
    image: mysql:8.0
    container_name: systemosiot-db
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=systemosiot
      - MYSQL_USER=systemosiot_user
      - MYSQL_PASSWORD=user_password
    ports:
      - "3306:3306"
    volumes:
      - db-data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    networks:
      - app-network

  redis:
    image: redis:6.2-alpine
    container_name: systemosiot-redis
    command: redis-server --requirepass redis_password
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - app-network

  rabbitmq:
    image: rabbitmq:3.9-management
    container_name: systemosiot-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=systemosiot_user
      - RABBITMQ_DEFAULT_PASS=mq_password
      - RABBITMQ_DEFAULT_VHOST=/systemosiot
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    restart: unless-stopped
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    container_name: systemosiot-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - app-network

volumes:
  app-logs:
  db-data:
  redis-data:
  rabbitmq-data:

networks:
  app-network:
    driver: bridge
```

### Kuberneteséƒ¨ç½² / Kubernetes Deployment

#### åº”ç”¨éƒ¨ç½²é…ç½®

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: systemosiot-app
  namespace: systemosiot
  labels:
    app: systemosiot
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: systemosiot
  template:
    metadata:
      labels:
        app: systemosiot
        version: v1.0.0
    spec:
      containers:
      - name: systemosiot-app
        image: systemosiot:1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        - name: DB_URL
          valueFrom:
            secretKeyRef:
              name: systemosiot-secrets
              key: db-url
        - name: DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: systemosiot-secrets
              key: db-username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: systemosiot-secrets
              key: db-password
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        volumeMounts:
        - name: app-logs
          mountPath: /var/log/systemosiot
      volumes:
      - name: app-logs
        emptyDir: {}
      imagePullSecrets:
      - name: systemosiot-registry-secret
```

#### æœåŠ¡é…ç½®

```yaml
# k8s/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: systemosiot-service
  namespace: systemosiot
spec:
  selector:
    app: systemosiot
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: systemosiot-ingress
  namespace: systemosiot
spec:
  selector:
    app: systemosiot
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  type: ClusterIP
```

#### Ingressé…ç½®

```yaml
# k8s/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: systemosiot-ingress
  namespace: systemosiot
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - api.systemosiot.com
    secretName: systemosiot-tls
  rules:
  - host: api.systemosiot.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: systemosiot-ingress
            port:
              number: 8080
```

## ðŸ¤– è‡ªåŠ¨åŒ–éƒ¨ç½² / Automated Deployment

### CI/CDæµæ°´çº¿ / CI/CD Pipeline

#### GitHub Actionsé…ç½®

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Run tests
      run: mvn clean test
    
    - name: Build application
      run: mvn clean package -DskipTests
    
    - name: Build Docker image
      run: docker build -t systemosiot:${{ github.ref_name }} .
    
    - name: Push Docker image
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker tag systemosiot:${{ github.ref_name }} ${{ secrets.DOCKER_USERNAME }}/systemosiot:${{ github.ref_name }}
        docker push ${{ secrets.DOCKER_USERNAME }}/systemosiot:${{ github.ref_name }}

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to Kubernetes
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" > kubeconfig.yaml
        export KUBECONFIG=kubeconfig.yaml
        
        # æ›´æ–°é•œåƒæ ‡ç­¾
        sed -i "s|image: systemosiot:.*|image: ${{ secrets.DOCKER_USERNAME }}/systemosiot:${{ github.ref_name }}|g" k8s/deployment.yaml
        
        # åº”ç”¨é…ç½®
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/secrets.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/ingress.yaml
        
        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        kubectl rollout status deployment/systemosiot-app -n systemosiot
        
        # å¥åº·æ£€æŸ¥
        kubectl get pods -n systemosiot
        kubectl get services -n systemosiot
```

#### Jenkins Pipelineé…ç½®

```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = 'systemosiot'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        KUBE_NAMESPACE = 'systemosiot'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn test'
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
                sh "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest"
            }
        }
        
        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-registry', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh "echo ${DOCKER_PASS} | docker login -u ${DOCKER_USER} --password-stdin"
                    sh "docker push ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    sh "docker push ${DOCKER_IMAGE}:latest"
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    // æ›´æ–°éƒ¨ç½²é…ç½®
                    sh "sed -i 's|image: systemosiot:.*|image: ${DOCKER_IMAGE}:${DOCKER_TAG}|g' k8s/deployment.yaml"
                    
                    // åº”ç”¨Kubernetesé…ç½®
                    sh "kubectl apply -f k8s/namespace.yaml"
                    sh "kubectl apply -f k8s/secrets.yaml"
                    sh "kubectl apply -f k8s/deployment.yaml"
                    sh "kubectl apply -f k8s/service.yaml"
                    sh "kubectl apply -f k8s/ingress.yaml"
                    
                    // ç­‰å¾…éƒ¨ç½²å®Œæˆ
                    sh "kubectl rollout status deployment/systemosiot-app -n ${KUBE_NAMESPACE}"
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    // ç­‰å¾…æœåŠ¡å¯åŠ¨
                    sleep 30
                    
                    // æ£€æŸ¥æœåŠ¡çŠ¶æ€
                    sh "kubectl get pods -n ${KUBE_NAMESPACE}"
                    sh "kubectl get services -n ${KUBE_NAMESPACE}"
                    
                    // å¥åº·æ£€æŸ¥
                    sh "curl -f http://localhost:8080/actuator/health || exit 1"
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            echo 'Deployment successful!'
        }
        failure {
            echo 'Deployment failed!'
            // å‘é€å¤±è´¥é€šçŸ¥
        }
    }
}
```

## ðŸ“Š ç›‘æŽ§å’Œå‘Šè­¦ / Monitoring and Alerting

### ç›‘æŽ§ä½“ç³» / Monitoring System

#### Prometheusé…ç½®

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "rules/*.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  - job_name: 'systemosiot-app'
    static_configs:
      - targets: ['app:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
    
  - job_name: 'mysql'
    static_configs:
      - targets: ['db:9104']
    scrape_interval: 30s
    
  - job_name: 'redis'
    static_configs:
      - targets: ['redis:9121']
    scrape_interval: 30s
    
  - job_name: 'rabbitmq'
    static_configs:
      - targets: ['rabbitmq:15692']
    scrape_interval: 30s
```

#### å‘Šè­¦è§„åˆ™

```yaml
# rules/alerts.yml
groups:
  - name: systemosiot_alerts
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(process_cpu_seconds_total[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPUä½¿ç”¨çŽ‡è¿‡é«˜"
          description: "å®žä¾‹ {{ $labels.instance }} CPUä½¿ç”¨çŽ‡è¶…è¿‡80%"
      
      - alert: HighMemoryUsage
        expr: (jvm_memory_used_bytes / jvm_memory_max_bytes * 100) > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å†…å­˜ä½¿ç”¨çŽ‡è¿‡é«˜"
          description: "å®žä¾‹ {{ $labels.instance }} å†…å­˜ä½¿ç”¨çŽ‡è¶…è¿‡85%"
      
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le)) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å“åº”æ—¶é—´è¿‡é«˜"
          description: "å®žä¾‹ {{ $labels.instance }} P95å“åº”æ—¶é—´è¶…è¿‡1ç§’"
      
      - alert: HighErrorRate
        expr: rate(http_server_requests_total{status=~"5.."}[5m]) / rate(http_server_requests_total[5m]) * 100 > 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "é”™è¯¯çŽ‡è¿‡é«˜"
          description: "å®žä¾‹ {{ $labels.instance }} é”™è¯¯çŽ‡è¶…è¿‡5%"
      
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "æœåŠ¡ä¸å¯ç”¨"
          description: "å®žä¾‹ {{ $labels.instance }} æœåŠ¡ä¸å¯ç”¨"
```

### æ—¥å¿—ç®¡ç† / Log Management

#### ELK Stacké…ç½®

```yaml
# docker-compose.logging.yml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - logging

  logstash:
    image: docker.elastic.co/logstash/logstash:7.17.0
    container_name: logstash
    ports:
      - "5044:5044"
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline
      - ./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml
    networks:
      - logging
    depends_on:
      - elasticsearch

  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.0
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    networks:
      - logging
    depends_on:
      - elasticsearch

volumes:
  elasticsearch-data:

networks:
  logging:
    driver: bridge
```

## ðŸ› ï¸ è¿ç»´æ“ä½œæŒ‡å— / Operations Guide

### æ—¥å¸¸è¿ç»´æ“ä½œ / Daily Operations

#### åº”ç”¨é‡å¯è„šæœ¬

```bash
#!/bin/bash
# restart-app.sh

APP_NAME="systemosiot"
NAMESPACE="systemosiot"
DEPLOYMENT="systemosiot-app"

echo "å¼€å§‹é‡å¯åº”ç”¨: $APP_NAME"

# æ£€æŸ¥åº”ç”¨çŠ¶æ€
echo "æ£€æŸ¥å½“å‰åº”ç”¨çŠ¶æ€..."
kubectl get pods -n $NAMESPACE -l app=$APP_NAME

# æ‰§è¡Œæ»šåŠ¨é‡å¯
echo "æ‰§è¡Œæ»šåŠ¨é‡å¯..."
kubectl rollout restart deployment/$DEPLOYMENT -n $NAMESPACE

# ç­‰å¾…é‡å¯å®Œæˆ
echo "ç­‰å¾…é‡å¯å®Œæˆ..."
kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE

# æ£€æŸ¥é‡å¯åŽçŠ¶æ€
echo "æ£€æŸ¥é‡å¯åŽçŠ¶æ€..."
kubectl get pods -n $NAMESPACE -l app=$APP_NAME

# å¥åº·æ£€æŸ¥
echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
kubectl get services -n $NAMESPACE
kubectl get ingress -n $NAMESPACE

echo "åº”ç”¨é‡å¯å®Œæˆ"
```

#### æ•°æ®åº“å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# backup-database.sh

DB_HOST="localhost"
DB_PORT="3306"
DB_NAME="systemosiot"
DB_USER="backup_user"
DB_PASSWORD="backup_password"
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/systemosiot_$DATE.sql"

echo "å¼€å§‹æ•°æ®åº“å¤‡ä»½..."

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
mysqldump -h $DB_HOST -P $DB_PORT -u $DB_USER -p$DB_PASSWORD \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    $DB_NAME > $BACKUP_FILE

# æ£€æŸ¥å¤‡ä»½ç»“æžœ
if [ $? -eq 0 ]; then
    echo "æ•°æ®åº“å¤‡ä»½æˆåŠŸ: $BACKUP_FILE"
    
    # åŽ‹ç¼©å¤‡ä»½æ–‡ä»¶
    gzip $BACKUP_FILE
    echo "å¤‡ä»½æ–‡ä»¶å·²åŽ‹ç¼©: $BACKUP_FILE.gz"
    
    # æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶ï¼ˆä¿ç•™30å¤©ï¼‰
    find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
    echo "å·²æ¸…ç†30å¤©å‰çš„å¤‡ä»½æ–‡ä»¶"
else
    echo "æ•°æ®åº“å¤‡ä»½å¤±è´¥"
    exit 1
fi
```

### æ•…éšœå¤„ç†æµç¨‹ / Troubleshooting Process

#### æ•…éšœå“åº”æµç¨‹

```markdown
## æ•…éšœå“åº”æµç¨‹ / Incident Response Process

### 1. æ•…éšœå‘çŽ° / Incident Discovery
- ç›‘æŽ§å‘Šè­¦è§¦å‘
- ç”¨æˆ·åé¦ˆ
- è¿ç»´äººå‘˜å‘çŽ°

### 2. æ•…éšœè¯„ä¼° / Incident Assessment
- ç¡®å®šæ•…éšœä¸¥é‡ç¨‹åº¦
- è¯„ä¼°å½±å“èŒƒå›´
- åˆæ­¥åˆ†æžåŽŸå› 

### 3. åº”æ€¥å“åº” / Emergency Response
- ç«‹å³é‡‡å–æŽªæ–½æ¢å¤æœåŠ¡
- é€šçŸ¥ç›¸å…³äººå‘˜
- å¯åŠ¨æ•…éšœå¤„ç†æµç¨‹

### 4. æ•…éšœåˆ†æž / Incident Analysis
- æ·±å…¥åˆ†æžæ•…éšœåŽŸå› 
- æ”¶é›†ç›¸å…³æ—¥å¿—å’ŒæŒ‡æ ‡
- ç¡®å®šæ ¹æœ¬åŽŸå› 

### 5. æ•…éšœä¿®å¤ / Incident Resolution
- å®žæ–½ä¿®å¤æ–¹æ¡ˆ
- éªŒè¯ä¿®å¤æ•ˆæžœ
- æ¢å¤æœåŠ¡æ­£å¸¸è¿è¡Œ

### 6. æ€»ç»“å¤ç›˜ / Post-Incident Review
- è®°å½•æ•…éšœå¤„ç†è¿‡ç¨‹
- åˆ†æžå¤„ç†è¿‡ç¨‹ä¸­çš„é—®é¢˜
- åˆ¶å®šæ”¹è¿›æŽªæ–½
- æ›´æ–°åº”æ€¥é¢„æ¡ˆ
```

#### å¸¸è§æ•…éšœå¤„ç† / Common Incident Handling

```bash
#!/bin/bash
# incident-response.sh

INCIDENT_ID=$(date +%Y%m%d_%H%M%S)
LOG_FILE="/var/log/incidents/incident_$INCIDENT_ID.log"

echo "æ•…éšœå“åº”è„šæœ¬å¯åŠ¨ - æ•…éšœID: $INCIDENT_ID" | tee -a $LOG_FILE

# æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
check_system_status() {
    echo "æ£€æŸ¥ç³»ç»ŸçŠ¶æ€..." | tee -a $LOG_FILE
    
    # æ£€æŸ¥åº”ç”¨çŠ¶æ€
    kubectl get pods -n systemosiot | tee -a $LOG_FILE
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    kubectl get services -n systemosiot | tee -a $LOG_FILE
    
    # æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µ
    kubectl top pods -n systemosiot | tee -a $LOG_FILE
}

# æ”¶é›†è¯Šæ–­ä¿¡æ¯
collect_diagnostics() {
    echo "æ”¶é›†è¯Šæ–­ä¿¡æ¯..." | tee -a $LOG_FILE
    
    # æ”¶é›†åº”ç”¨æ—¥å¿—
    kubectl logs -n systemosiot -l app=systemosiot --tail=100 | tee -a $LOG_FILE
    
    # æ”¶é›†ç³»ç»ŸæŒ‡æ ‡
    kubectl exec -n systemosiot deployment/systemosiot-app -- top -b -n 1 | tee -a $LOG_FILE
    
    # æ£€æŸ¥æ•°æ®åº“è¿žæŽ¥
    kubectl exec -n systemosiot deployment/systemosiot-app -- curl -f http://localhost:8080/actuator/health | tee -a $LOG_FILE
}

# æ‰§è¡Œåº”æ€¥æŽªæ–½
emergency_response() {
    echo "æ‰§è¡Œåº”æ€¥æŽªæ–½..." | tee -a $LOG_FILE
    
    # é‡å¯é—®é¢˜Pod
    kubectl delete pod -n systemosiot -l app=systemosiot --force --grace-period=0 | tee -a $LOG_FILE
    
    # ç­‰å¾…Podé‡å¯
    sleep 30
    
    # æ£€æŸ¥é‡å¯ç»“æžœ
    kubectl get pods -n systemosiot | tee -a $LOG_FILE
}

# ä¸»æµç¨‹
main() {
    echo "å¼€å§‹æ•…éšœå“åº”æµç¨‹..." | tee -a $LOG_FILE
    
    check_system_status
    collect_diagnostics
    emergency_response
    
    echo "æ•…éšœå“åº”æµç¨‹å®Œæˆ" | tee -a $LOG_FILE
}

# æ‰§è¡Œä¸»æµç¨‹
main
```

---

> æœ¬éƒ¨ç½²è¿ç»´æŒ‡å—ä¸ºSystemOSIOTé¡¹ç›®æä¾›å®Œæ•´çš„éƒ¨ç½²å’Œè¿ç»´ä½“ç³»ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œé«˜æ•ˆç»´æŠ¤ã€‚
> This deployment and operations guide provides a complete deployment and operations system for the SystemOSIOT project, ensuring stable system operation and efficient maintenance.
