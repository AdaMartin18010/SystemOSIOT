# 跨层可观测性：统一时间线与事件关联指南

## 1. 目标

- 将 vCenter/ESXi 事件、Guest OS 指标、容器/服务网格遥测、eBPF 事件统一到同一时间轴，实现因果回放与根因分析。

## 2. 时间与标签

- 时间源：NTP/PTP 统一；记录时钟偏移与置信区间。
- 关联标签：VM ID、Pod UID、Container ID、Namespace、Service、ESXi Host、Datastore、Segment。
- 时钟模型：
  - 统一参考时钟 T_ref（PTP 优先，NTP 兜底），所有事件以 (t, σ) 记录时间和不确定度。
  - 事件对齐采用窗口匹配与因果约束（如“迁移开始在网络抖动前”）。

### 2.1 OTel 语义与标签命名约定（E-2025-0303）

- 资源（resource）：`service.name`, `service.namespace`, `k8s.namespace.name`, `k8s.pod.uid`, `k8s.container.name`, `vm.id`, `esxi.host.name`。
- 指标（metric labels）：统一使用 `job`, `instance`, `namespace`, `pod`, `container`, `vm_id`, `esxi_host`, `datastore`。
- 日志（attributes）：`trace_id`, `span_id`, `peer.address`, `net.peer.name`, `net.peer.port`, `error`。
- 规范：跨文档尽量选择上述键名；如需工程特定键，使用前缀 `x_` 并在文档结尾登记。

## 3. 数据面与控制面

- 控制面：vCenter 事件（迁移/快照/重启）、K8s 事件（调度/重建/HPA）、CI/CD 变更。
- 数据面：eBPF Kprobe/Tracepoint、网络流（sFlow/IPFIX）、应用指标（RED/USE）。
- 证据键：E-2025-0301（PTP/NTP 精度参考）、E-2025-0302（vCenter 事件字典）、E-2025-0303（OTel 语义约定）。

## 4. 采集与管道

- 采集：vCenter API、node-exporter/cAdvisor、eBPF（bcc/bpftrace）、service mesh 遥测。
- 管道：OTel Collector 统一接入，Prometheus/Tempo/Loki/Elasticsearch 存储与查询。
- 采集频率：关键窗口期间启用高频采样（如 1s/100ms）；平时降采样并保持事件钉扎。

## 5. 回放与规则

- 回放：以“事件”为锚点串联跨层指标，生成时序图；提供 p99/p999 突变定位与邻接因果链。
- 规则：SLO/SLA 规则引擎（如 Alertmanager/自研）结合 vCenter 事件做富上下文告警。
- 示例时间线：
  1) T0 vMotion.Start(hostA→hostB)
  2) T0+Δ1 Network.TxDrops↑（VMXNET3 queue）
  3) T0+Δ2 Service p99↑/Error↑
  4) T1 vMotion.End；T1+Δ3 指标恢复
  5) 结论：Δ 区间与事件序满足因果链，SLO 影响 X 分钟（E-2025-0304）。

### 5.1 示例查询与面板（Grafana/PromQL/Tempo/Loki）

- PromQL：定位 vMotion 窗口内服务延迟突变
  - `histogram_quantile(0.99, sum by (le, job, instance) (rate(http_request_duration_seconds_bucket{namespace="ns-a"}[5m])))`
  - 与 vCenter 事件时间窗 [T0, T1] 进行区间交集过滤。

- Loki：按 VM 与 Pod 关联标签过滤错误日志
  - `{app="svc-a", vm_id="vm-123", pod_uid="..."} |~ "(timeout|error|5..|unavailable)"`

- Tempo：按 TraceID 聚合跨层 span，查看因果链
  - 过滤标签：`vm_id`, `pod_uid`, `esxi_host`，对齐时间窗 [T0, T1]。

- eBPF/bpftrace：捕获 VMXNET3 队列丢包与软中断
  - `kprobe:vmxnet3_rq_rx_complete { @drops[pid] = count(); }`

> 以上查询需统一标签方案与证据键：E-2025-0303（OTel 语义约定）。

## 6. 安全与合规

- 数据访问分级与脱敏；采集最小化原则；审计与留痕；SBOM 与签名校验。

## 7. 最佳实践

- 建立基线仪表盘：VM/容器/应用三视图；关键事件与指标同屏。
- 变更闸口：大规模迁移/升级前开启“高频采样与事件钉扎”，事后回放核对 SLO。
- 工件化：保存回放脚本、事件快照与图谱为可复现实验；输出证据编号与版本。
