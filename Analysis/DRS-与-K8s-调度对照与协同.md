# vCenter DRS × Kubernetes 调度：对照与协同

## 1. 目标

- 对比 DRS（集群资源均衡/迁移）与 K8s（Pod 绑定/打散/约束）在目标函数、约束、时序上的差异。
- 给出协同策略，避免“上层调度与底层迁移”相互干扰。

### 1.1 范围与边界（Scope & Non-goals）

- 定位：知识梳理与策略论证；不涉及生产自动化实现。
- 对标：vCenter/DRS 官方文档、K8s 调度文档、社区 KEP；MIT/CMU 相关课程材料。
- 证据：文档版本、章节/链接可复核。

## 2. 模型与目标

- DRS：主机负载均衡、SLA/SLO 保障、避免热点；手段为 vMotion/资源份额/保留与限制。
- K8s：满足调度约束（NodeSelector/Affinity/Taints）、Bin Packing、反亲和打散、优先级抢占。

### 2.1 形式化刻画（摘要）

- 目标函数与约束集合：min 迁移代价、min 延迟/抖动、满足亲和/污点约束。
- 冲突判定：存在使约束集不可满足的 DRS 迁移时序 → 触发抑制策略。
- 变量定义：
  - 工作负载集合 W，节点集合 N，VM 集合 V；映射 f_k8s: W→N，g_vm: V→N。
  - 代价函数 C_mig(v): VM v 的迁移代价；L(w): 工作负载 w 的尾延迟；R(n): 节点 n 的资源余量。
- 目标（示例）：
  - 最小化 Σ C_mig(v) 且保持 L(w) ≤ SLO(w)，并满足拓扑/亲和/反亲和与安全域约束。
- 抑制条件：若 ∃ w∈W，其承载 VM 拟迁移导致 f_k8s(w) 与 g_vm(VM(w)) 的拓扑亲和冲突，则 DRS 推迟或放弃迁移（E-2025-0201）。

## 3. 时序与冲突

- 时序：K8s 调度在前（Pod→Node 绑定）；DRS 在后（主机层迁移 VM）。
- 冲突：DRS 将承载关键 Pod 的 VM 迁移到不符合 K8s 偏好的节点，或引入瞬时资源波动，影响延迟。
- 案例：
  - 强一致数据库副本设置了 `podAntiAffinity` 保证跨故障域打散；DRS 为均衡 CPU 将某副本承载 VM 迁移至同故障域，破坏打散（E-2025-0202）。
  - 低延迟服务在迁移窗口出现 p99 尾部放大，触发上层熔断导致级联失败。

## 4. 协同策略

1) 抑制抖动：为关键工作负载的承载 VM 设定 DRS 规则（Must/Should）与维护窗口；K8s 对关键 Pod 进行节点亲和与污点配合。
2) 亲和一致：在 vCenter 标记（Tag/Folder）与 K8s Label 之间建立映射，保持拓扑意图一致。
3) 资源对齐：vCPU/vMem 保留与 K8s 请求/限制对齐，减少超配差造成的双重拥塞。
4) 事件联动：DRS 迁移事件触发 K8s HPA/弹性抑制或服务熔断策略，避免级联抖动。
5) 金丝雀迁移：对无状态副本先小批量迁移并回放流量，验证无异常后扩大范围。
6) 固定关键副本：为共识/仲裁节点提供“不得迁移”或“需审批迁移”的策略门槛。

## 5. 观测与回归

- 指标：vCPU 就绪时间、迁移时长、Pod 启动/重调度耗时、服务端到端 p99。
- 方法：vCenter 事件流 ↔ K8s 事件/日志 ↔ eBPF 时序，构建统一时间轴回放。
- 证据回放：对每次迁移生成时间线：T0 迁移开始 → T1 vMotion 完成 → T2 应用指标恢复；与对照组比较差分（E-2025-0203）。

### 5.1 基准方法学（Benchmark Methodology）

- 实验设计：固定版本/配置，控制迁移频率与负载型谱；重复实验取置信区间。
- 指标汇总：p50/p95/p99 延迟、可用性、迁移动作的抖动与尾部放大。

## 6. 实施建议

- 建立“调度-迁移-扩缩”三方闭环：K8s 调度 → DRS 评估 → 若迁移则同步 K8s Gate，迁移完成再恢复扩缩。
- 对实时/低延迟工作负载：限制 DRS 自动迁移，采用固定亲和与资源保留策略。
- 变更管理：迁移策略以代码化配置存储，审计与签名；回放与基线对比纳入发布闸口。

## 7. 参考与链接

- 官方文档与论文：待补精确节页与版本（E-2025-0201/0202/0203）。
