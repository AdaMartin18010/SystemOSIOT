# 网络系统：OS × vSphere/VMware × 容器 × 图灵机 多视角映射

## 1. 概述

- 主题：协议栈、转发与队列、策略与微分段、可观测性与故障定位。

## 2. OS 视角

- 协议栈参数（RPS/RFS/GRO/GSO/TSO）、XDP/eBPF、tc/qdisc；iptables/nft。

## 3. vSphere/VMware 视角

- vSwitch/NSX 分布式防火墙、Segment/T1/T0；微分段与分层策略；Traceflow/Trace Policy。

### 3.1 对标特性与差异

- NSX DFW 与 K8s NetworkPolicy 的匹配域/优先级/状态持有差异；需要统一“显式拒绝/允许”原则（E-2025-0501/0010）。
- 南北向（T1/T0、NAT、L7 网关）与 K8s Ingress/Service 的语义边界；七层策略与四层策略的合成顺序与冲突处理（E-2025-0010）。
- Traceflow/Trace Policy 与 eBPF 路径观测的覆盖边界与互补。

## 4. 容器视角

- CNI/Service/NetworkPolicy、Service Mesh（mTLS/遥测/路由）、多网络（Multus）。

## 5. 图灵机视角

- 网络策略可形式化描述并可在不同执行环境模拟；开销源于数据平面实现差异。

## 6. 多维映射（摘要）

| 维度 | OS | vSphere/VMware | 容器 | 备注 |
|---|---|---|---|---|
| 吞吐 | 驱动/零拷 | vSwitch/硬加速 | CNI/DPDK | 硬件分流 |
| 安全 | LSM/防火墙 | NSX DFW | NetworkPolicy/OPA | 策略一致性 |
| 可观测 | eBPF/pcap | Traceflow | Mesh 遥测 | 统一时间线 |
| 证据编号 | E-2025-0502 | E-2025-0501 | E-2025-0010/0032 | 对应 9 |

## 7. 建议

- 策略统一：采用“源策略→生成 NSX/CNI 工件→回放验证”的流水线，避免阴影规则。
- 数据面优化：
  - OS：合适的 RPS/RFS、GRO/TSO、队列与中断亲和；
  - vSphere：开启适当的硬件分流/大帧，NSX Traceflow 验证路径；
  - 容器：选择支持 eBPF 的 CNI（如 Cilium）或 DPDK 路径，评估 p99 尾部。

### 7.1 基准方法学（Benchmark Methodology）

- 指标：端到端吞吐、p95/p99、误阻断率、策略命中率、观测覆盖率。
- 设计：固定策略集→生成流量矩阵→事件钉扎→统一时间线回放（E-2025-0303/0304）。
- 工具：NSX Traceflow、CNI 可观测（Hubble/Flow logs）、OTel/Tempo/Loki、eBPF。

## 8. 相关目录链接

## 9. 参考与链接

- 文档/产品：NSX DFW/Traceflow（E-2025-0501）
- CNI/策略/网格文档（E-2025-0010/0032）
- OS 网络调优参考（E-2025-0502）

- `08-network-systems/` 总览与各子章节
- `07-container-microservices/`（CNI/Service Mesh）
- `Analysis/NSX-与-CNI-策略与微分段映射.md`
